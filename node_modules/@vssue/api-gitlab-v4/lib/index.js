import * as tslib_1 from "tslib";
import axios from 'axios';
import { buildURL, concatURL, getCleanURL, parseQuery, } from '@vssue/utils';
import { normalizeUser, normalizeIssue, normalizeComment, normalizeReactions, mapReactionName, } from './utils';
/**
 * GitLab API V4
 *
 * @see https://docs.gitlab.com/ce/api/
 * @see https://docs.gitlab.com/ce/api/oauth2.html
 */
var GitlabV4 = /** @class */ (function () {
    function GitlabV4(_a) {
        var _b = _a.baseURL, baseURL = _b === void 0 ? 'https://gitlab.com' : _b, owner = _a.owner, repo = _a.repo, labels = _a.labels, clientId = _a.clientId, clientSecret = _a.clientSecret, state = _a.state;
        this.baseURL = baseURL;
        this.owner = owner;
        this.repo = repo;
        this.labels = labels.join(',');
        this.clientId = clientId;
        this.clientSecret = clientSecret;
        this.state = state;
        // @see https://docs.gitlab.com/ce/api/README.html#namespaced-path-encoding
        this._encodedRepo = encodeURIComponent(this.owner + "/" + this.repo);
        this.$http = axios.create({
            baseURL: baseURL,
            headers: {
                'Accept': 'application/json',
            },
        });
    }
    Object.defineProperty(GitlabV4.prototype, "platform", {
        /**
         * The platform api info
         */
        get: function () {
            return {
                name: 'GitLab',
                link: this.baseURL,
                version: 'v4',
                meta: {
                    reactable: true,
                    sortable: true,
                },
            };
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Redirect to the authorization page of platform.
     *
     * @see https://docs.gitlab.com/ce/api/oauth2.html#1-requesting-authorization-code
     */
    GitlabV4.prototype.redirectAuth = function () {
        window.location.href = buildURL(concatURL(this.baseURL, 'oauth/authorize'), {
            client_id: this.clientId,
            redirect_uri: window.location.href,
            response_type: 'code',
            state: this.state,
        });
    };
    /**
     * Handle authorization.
     *
     * @return A string for access token, `null` for no authorization code
     *
     * @see https://docs.gitlab.com/ce/api/oauth2.html#supported-oauth2-flows
     *
     * @remarks
     * If the `code` and `state` exist in the query, and the `state` matches, remove them from query, and try to get the access token.
     */
    GitlabV4.prototype.handleAuth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var query, code, replaceURL, accessToken;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        query = parseQuery(window.location.search);
                        if (!query.code) return [3 /*break*/, 2];
                        if (query.state !== this.state) {
                            return [2 /*return*/, null];
                        }
                        code = query.code;
                        delete query.code;
                        delete query.state;
                        replaceURL = buildURL(getCleanURL(window.location.href), query) + window.location.hash;
                        window.history.replaceState(null, '', replaceURL);
                        return [4 /*yield*/, this.getAccessToken({ code: code })];
                    case 1:
                        accessToken = _a.sent();
                        return [2 /*return*/, accessToken];
                    case 2: return [2 /*return*/, null];
                }
            });
        });
    };
    /**
     * Get user access token via `code`
     *
     * @param options.code - The code from the query
     *
     * @return User access token
     *
     * @see https://docs.gitlab.com/ce/api/oauth2.html#2-requesting-access-token
     */
    GitlabV4.prototype.getAccessToken = function (_a) {
        var code = _a.code;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("https://cors-anywhere.herokuapp.com/" + concatURL(this.baseURL, 'oauth/token'), {
                            client_id: this.clientId,
                            client_secret: this.clientSecret,
                            code: code,
                            grant_type: 'authorization_code',
                            redirect_uri: window.location.href,
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, data.access_token];
                }
            });
        });
    };
    /**
     * Get the logined user with access token.
     *
     * @param options.accessToken - User access token
     *
     * @return The user
     */
    GitlabV4.prototype.getUser = function (_a) {
        var accessToken = _a.accessToken;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.get('api/v4/user', {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeUser(data)];
                }
            });
        });
    };
    /**
     * Get issue of this page according to the issue id or the issue title
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.issueTitle - The title of issue
     *
     * @return The issue
     *
     * @see https://docs.gitlab.com/ce/api/issues.html#single-issue
     * @see https://docs.gitlab.com/ce/api/issues.html#list-issues
     * @see https://docs.gitlab.com/ce/api/README.html#pagination
     */
    GitlabV4.prototype.getIssue = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, issueTitle = _a.issueTitle;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, data, e_1, data, issue;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        options = {};
                        if (accessToken) {
                            options.headers = {
                                'Authorization': "Bearer " + accessToken,
                            };
                        }
                        if (!issueId) return [3 /*break*/, 5];
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.$http.get("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId, options)];
                    case 2:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeIssue(data)];
                    case 3:
                        e_1 = _b.sent();
                        if (e_1.response && e_1.response.status === 404) {
                            return [2 /*return*/, null];
                        }
                        else {
                            throw e_1;
                        }
                        return [3 /*break*/, 4];
                    case 4: return [3 /*break*/, 7];
                    case 5:
                        options.params = {
                            labels: this.labels,
                            order_by: 'created_at',
                            sort: 'asc',
                            search: issueTitle,
                        };
                        return [4 /*yield*/, this.$http.get("api/v4/projects/" + this._encodedRepo + "/issues", options)];
                    case 6:
                        data = (_b.sent()).data;
                        issue = data.map(normalizeIssue).find(function (item) { return item.title === issueTitle; });
                        return [2 /*return*/, issue || null];
                    case 7: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Create a new issue
     *
     * @param options.accessToken - User access token
     * @param options.title - The title of issue
     * @param options.content - The content of issue
     *
     * @return The created issue
     *
     * @see https://docs.gitlab.com/ce/api/issues.html#new-issue
     */
    GitlabV4.prototype.postIssue = function (_a) {
        var accessToken = _a.accessToken, title = _a.title, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("api/v4/projects/" + this._encodedRepo + "/issues", {
                            title: title,
                            description: content,
                            labels: this.labels,
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeIssue(data)];
                }
            });
        });
    };
    /**
     * Get comments of this page according to the issue id or the issue title
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.query - The query parameters
     *
     * @return The comments
     *
     * @see https://docs.gitlab.com/ce/api/notes.html#list-project-issue-notes
     * @see https://docs.gitlab.com/ce/api/README.html#pagination
     *
     * @remarks
     * Cannot get the HTML content and the reactions (award_emoji) here.
     * So have to request them via `markdown` and `award_emoji` API.
     */
    GitlabV4.prototype.getComments = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, _b = _a.query, _c = _b === void 0 ? {} : _b, _d = _c.page, page = _d === void 0 ? 1 : _d, _e = _c.perPage, perPage = _e === void 0 ? 10 : _e, _f = _c.sort, sort = _f === void 0 ? 'desc' : _f;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_2, _g, options, response, commentsRaw, getCommentsMeta, _loop_1, commentsRaw_1, commentsRaw_1_1, comment;
            var _this = this;
            return tslib_1.__generator(this, function (_h) {
                switch (_h.label) {
                    case 0:
                        options = {
                            params: {
                                // pagination
                                'page': page,
                                'per_page': perPage,
                                'order_by': 'created_at',
                                'sort': sort,
                            },
                        };
                        if (accessToken) {
                            options.headers = {
                                'Authorization': "Bearer " + accessToken,
                            };
                        }
                        return [4 /*yield*/, this.$http.get("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes", options)];
                    case 1:
                        response = _h.sent();
                        commentsRaw = response.data;
                        getCommentsMeta = [];
                        _loop_1 = function (comment) {
                            getCommentsMeta.push((function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                                var _a;
                                return tslib_1.__generator(this, function (_b) {
                                    switch (_b.label) {
                                        case 0:
                                            _a = comment;
                                            return [4 /*yield*/, this.getMarkdownContent({
                                                    accessToken: accessToken,
                                                    contentRaw: comment.body,
                                                })];
                                        case 1:
                                            _a.body_html = _b.sent();
                                            return [2 /*return*/];
                                    }
                                });
                            }); })());
                            getCommentsMeta.push((function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                                var _a;
                                return tslib_1.__generator(this, function (_b) {
                                    switch (_b.label) {
                                        case 0:
                                            _a = comment;
                                            return [4 /*yield*/, this.getCommentReactions({
                                                    accessToken: accessToken,
                                                    issueId: issueId,
                                                    commentId: comment.id,
                                                })];
                                        case 1:
                                            _a.reactions = _b.sent();
                                            return [2 /*return*/];
                                    }
                                });
                            }); })());
                        };
                        try {
                            for (commentsRaw_1 = tslib_1.__values(commentsRaw), commentsRaw_1_1 = commentsRaw_1.next(); !commentsRaw_1_1.done; commentsRaw_1_1 = commentsRaw_1.next()) {
                                comment = commentsRaw_1_1.value;
                                _loop_1(comment);
                            }
                        }
                        catch (e_2_1) { e_2 = { error: e_2_1 }; }
                        finally {
                            try {
                                if (commentsRaw_1_1 && !commentsRaw_1_1.done && (_g = commentsRaw_1.return)) _g.call(commentsRaw_1);
                            }
                            finally { if (e_2) throw e_2.error; }
                        }
                        return [4 /*yield*/, Promise.all(getCommentsMeta)];
                    case 2:
                        _h.sent();
                        return [2 /*return*/, {
                                count: Number(response.headers['x-total']),
                                page: Number(response.headers['x-page']),
                                perPage: Number(response.headers['x-per-page']),
                                data: commentsRaw.map(normalizeComment),
                            }];
                }
            });
        });
    };
    /**
     * Create a new comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.content - The content of comment
     *
     * @return The created comment
     *
     * @see https://docs.gitlab.com/ce/api/notes.html#create-new-issue-note
     */
    GitlabV4.prototype.postComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes", {
                            body: content,
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeComment(data)];
                }
            });
        });
    };
    /**
     * Edit a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     * @param options.content - The content of comment
     *
     * @return The edited comment
     *
     * @see https://docs.gitlab.com/ce/api/notes.html#modify-existing-issue-note
     */
    GitlabV4.prototype.putComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, commentId = _a.commentId, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data, _b, contentHTML, reactions;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0: return [4 /*yield*/, this.$http.put("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes/" + commentId, {
                            body: content,
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_c.sent()).data;
                        return [4 /*yield*/, Promise.all([
                                this.getMarkdownContent({
                                    accessToken: accessToken,
                                    contentRaw: data.body,
                                }),
                                this.getCommentReactions({
                                    accessToken: accessToken,
                                    issueId: issueId,
                                    commentId: data.id,
                                }),
                            ])];
                    case 2:
                        _b = tslib_1.__read.apply(void 0, [_c.sent(), 2]), contentHTML = _b[0], reactions = _b[1];
                        data.body_html = contentHTML;
                        data.reactions = reactions;
                        return [2 /*return*/, normalizeComment(data)];
                }
            });
        });
    };
    /**
     * Delete a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     *
     * @return `true` if succeed, `false` if failed
     *
     * @see https://docs.gitlab.com/ce/api/notes.html#delete-an-issue-note
     */
    GitlabV4.prototype.deleteComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, commentId = _a.commentId;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var status;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.delete("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes/" + commentId, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        status = (_b.sent()).status;
                        return [2 /*return*/, status === 204];
                }
            });
        });
    };
    /**
     * Get reactions of a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     *
     * @return The comments
     *
     * @see https://docs.gitlab.com/ce/api/award_emoji.html#list-an-awardables-award-emoji
     */
    GitlabV4.prototype.getCommentReactions = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, commentId = _a.commentId;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.get("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes/" + commentId + "/award_emoji", {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeReactions(data)];
                }
            });
        });
    };
    /**
     * Create a new reaction of a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     * @param options.reaction - The reaction
     *
     * @return `true` if succeed, `false` if already token
     *
     * @see https://docs.gitlab.com/ce/api/award_emoji.html#award-a-new-emoji
     */
    GitlabV4.prototype.postCommentReaction = function (_a) {
        var issueId = _a.issueId, commentId = _a.commentId, reaction = _a.reaction, accessToken = _a.accessToken;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var response, e_3;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.$http.post("api/v4/projects/" + this._encodedRepo + "/issues/" + issueId + "/notes/" + commentId + "/award_emoji", {
                                name: mapReactionName(reaction),
                            }, {
                                headers: {
                                    'Authorization': "Bearer " + accessToken,
                                },
                            })];
                    case 1:
                        response = _b.sent();
                        return [2 /*return*/, response.status === 201];
                    case 2:
                        e_3 = _b.sent();
                        // it could be a bug of gitlab
                        // if a reaction (award emoji) has already existed, it returns a 404 response with a buggy message
                        // have submitted an issue: https://gitlab.com/gitlab-org/gitlab-ce/issues/56147
                        if (e_3.response && e_3.response.status === 404) {
                            return [2 /*return*/, false];
                        }
                        else {
                            throw e_3;
                        }
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Get the parse HTML of markdown content
     *
     * @param options.accessToken - User access token
     * @param options.contentRaw - The id of issue
     *
     * @return The HTML string of parsed markdown
     *
     * @see https://docs.gitlab.com/ce/api/markdown.html
     */
    GitlabV4.prototype.getMarkdownContent = function (_a) {
        var accessToken = _a.accessToken, contentRaw = _a.contentRaw;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        options = {};
                        if (accessToken) {
                            options.headers = {
                                'Authorization': "Bearer " + accessToken,
                            };
                        }
                        return [4 /*yield*/, this.$http.post("api/v4/markdown", {
                                text: contentRaw,
                                gfm: true,
                            }, options)];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, data.html];
                }
            });
        });
    };
    return GitlabV4;
}());
export default GitlabV4;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLE9BQU8sS0FHTixNQUFNLE9BQU8sQ0FBQTtBQUVkLE9BQU8sRUFDTCxRQUFRLEVBQ1IsU0FBUyxFQUNULFdBQVcsRUFDWCxVQUFVLEdBQ1gsTUFBTSxjQUFjLENBQUE7QUFFckIsT0FBTyxFQUNMLGFBQWEsRUFDYixjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQixlQUFlLEdBQ2hCLE1BQU0sU0FBUyxDQUFBO0FBRWhCOzs7OztHQUtHO0FBQ0g7SUFZRSxrQkFBYSxFQVFNO1lBUGpCLGVBQThCLEVBQTlCLG1EQUE4QixFQUM5QixnQkFBSyxFQUNMLGNBQUksRUFDSixrQkFBTSxFQUNOLHNCQUFRLEVBQ1IsOEJBQVksRUFDWixnQkFBSztRQUVMLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUU5QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQTtRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQTtRQUNoQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUVsQiwyRUFBMkU7UUFDM0UsSUFBSSxDQUFDLFlBQVksR0FBRyxrQkFBa0IsQ0FBSSxJQUFJLENBQUMsS0FBSyxTQUFJLElBQUksQ0FBQyxJQUFNLENBQUMsQ0FBQTtRQUVwRSxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDeEIsT0FBTyxTQUFBO1lBQ1AsT0FBTyxFQUFFO2dCQUNQLFFBQVEsRUFBRSxrQkFBa0I7YUFDN0I7U0FDRixD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QyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7Z0NBQ3hELElBQUksRUFBRSxVQUFVO2dDQUNoQixHQUFHLEVBQUUsSUFBSTs2QkFDVixFQUFFLE9BQU8sQ0FBQyxFQUFBOzt3QkFISCxJQUFJLEdBQUssQ0FBQSxTQUdOLENBQUEsS0FIQzt3QkFJWixzQkFBTyxJQUFJLENBQUMsSUFBSSxFQUFBOzs7O0tBQ2pCO0lBQ0gsZUFBQztBQUFELENBQUMsQUFwZkQsSUFvZkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWc3N1ZUFQSSB9IGZyb20gJ3Zzc3VlJ1xuXG5pbXBvcnQgYXhpb3MsIHtcbiAgQXhpb3NJbnN0YW5jZSxcbiAgQXhpb3NSZXF1ZXN0Q29uZmlnLFxufSBmcm9tICdheGlvcydcblxuaW1wb3J0IHtcbiAgYnVpbGRVUkwsXG4gIGNvbmNhdFVSTCxcbiAgZ2V0Q2xlYW5VUkwsXG4gIHBhcnNlUXVlcnksXG59IGZyb20gJ0B2c3N1ZS91dGlscydcblxuaW1wb3J0IHtcbiAgbm9ybWFsaXplVXNlcixcbiAgbm9ybWFsaXplSXNzdWUsXG4gIG5vcm1hbGl6ZUNvbW1lbnQsXG4gIG5vcm1hbGl6ZVJlYWN0aW9ucyxcbiAgbWFwUmVhY3Rpb25OYW1lLFxufSBmcm9tICcuL3V0aWxzJ1xuXG4vKipcbiAqIEdpdExhYiBBUEkgVjRcbiAqXG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRsYWIuY29tL2NlL2FwaS9cbiAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL29hdXRoMi5odG1sXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdpdGxhYlY0IGltcGxlbWVudHMgVnNzdWVBUEkuSW5zdGFuY2Uge1xuICBiYXNlVVJMOiBzdHJpbmdcbiAgb3duZXI6IHN0cmluZ1xuICByZXBvOiBzdHJpbmdcbiAgbGFiZWxzOiBzdHJpbmdcbiAgY2xpZW50SWQ6IHN0cmluZ1xuICBjbGllbnRTZWNyZXQ6IHN0cmluZ1xuICBzdGF0ZTogc3RyaW5nXG4gICRodHRwOiBBeGlvc0luc3RhbmNlXG5cbiAgcHJpdmF0ZSBfZW5jb2RlZFJlcG86IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yICh7XG4gICAgYmFzZVVSTCA9ICdodHRwczovL2dpdGxhYi5jb20nLFxuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gICAgbGFiZWxzLFxuICAgIGNsaWVudElkLFxuICAgIGNsaWVudFNlY3JldCxcbiAgICBzdGF0ZSxcbiAgfTogVnNzdWVBUEkuT3B0aW9ucykge1xuICAgIHRoaXMuYmFzZVVSTCA9IGJhc2VVUkxcbiAgICB0aGlzLm93bmVyID0gb3duZXJcbiAgICB0aGlzLnJlcG8gPSByZXBvXG4gICAgdGhpcy5sYWJlbHMgPSBsYWJlbHMuam9pbignLCcpXG5cbiAgICB0aGlzLmNsaWVudElkID0gY2xpZW50SWRcbiAgICB0aGlzLmNsaWVudFNlY3JldCA9IGNsaWVudFNlY3JldFxuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZVxuXG4gICAgLy8gQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvUkVBRE1FLmh0bWwjbmFtZXNwYWNlZC1wYXRoLWVuY29kaW5nXG4gICAgdGhpcy5fZW5jb2RlZFJlcG8gPSBlbmNvZGVVUklDb21wb25lbnQoYCR7dGhpcy5vd25lcn0vJHt0aGlzLnJlcG99YClcblxuICAgIHRoaXMuJGh0dHAgPSBheGlvcy5jcmVhdGUoe1xuICAgICAgYmFzZVVSTCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIH0sXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgcGxhdGZvcm0gYXBpIGluZm9cbiAgICovXG4gIGdldCBwbGF0Zm9ybSAoKTogVnNzdWVBUEkuUGxhdGZvcm0ge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnR2l0TGFiJyxcbiAgICAgIGxpbms6IHRoaXMuYmFzZVVSTCxcbiAgICAgIHZlcnNpb246ICd2NCcsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIHJlYWN0YWJsZTogdHJ1ZSxcbiAgICAgICAgc29ydGFibGU6IHRydWUsXG4gICAgICB9LFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWRpcmVjdCB0byB0aGUgYXV0aG9yaXphdGlvbiBwYWdlIG9mIHBsYXRmb3JtLlxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRsYWIuY29tL2NlL2FwaS9vYXV0aDIuaHRtbCMxLXJlcXVlc3RpbmctYXV0aG9yaXphdGlvbi1jb2RlXG4gICAqL1xuICByZWRpcmVjdEF1dGggKCk6IHZvaWQge1xuICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gYnVpbGRVUkwoY29uY2F0VVJMKHRoaXMuYmFzZVVSTCwgJ29hdXRoL2F1dGhvcml6ZScpLCB7XG4gICAgICBjbGllbnRfaWQ6IHRoaXMuY2xpZW50SWQsXG4gICAgICByZWRpcmVjdF91cmk6IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuICAgICAgcmVzcG9uc2VfdHlwZTogJ2NvZGUnLFxuICAgICAgc3RhdGU6IHRoaXMuc3RhdGUsXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgYXV0aG9yaXphdGlvbi5cbiAgICpcbiAgICogQHJldHVybiBBIHN0cmluZyBmb3IgYWNjZXNzIHRva2VuLCBgbnVsbGAgZm9yIG5vIGF1dGhvcml6YXRpb24gY29kZVxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRsYWIuY29tL2NlL2FwaS9vYXV0aDIuaHRtbCNzdXBwb3J0ZWQtb2F1dGgyLWZsb3dzXG4gICAqXG4gICAqIEByZW1hcmtzXG4gICAqIElmIHRoZSBgY29kZWAgYW5kIGBzdGF0ZWAgZXhpc3QgaW4gdGhlIHF1ZXJ5LCBhbmQgdGhlIGBzdGF0ZWAgbWF0Y2hlcywgcmVtb3ZlIHRoZW0gZnJvbSBxdWVyeSwgYW5kIHRyeSB0byBnZXQgdGhlIGFjY2VzcyB0b2tlbi5cbiAgICovXG4gIGFzeW5jIGhhbmRsZUF1dGggKCk6IFByb21pc2U8VnNzdWVBUEkuQWNjZXNzVG9rZW4+IHtcbiAgICBjb25zdCBxdWVyeSA9IHBhcnNlUXVlcnkod2luZG93LmxvY2F0aW9uLnNlYXJjaClcbiAgICBpZiAocXVlcnkuY29kZSkge1xuICAgICAgaWYgKHF1ZXJ5LnN0YXRlICE9PSB0aGlzLnN0YXRlKSB7XG4gICAgICAgIHJldHVybiBudWxsXG4gICAgICB9XG4gICAgICBjb25zdCBjb2RlID0gcXVlcnkuY29kZVxuICAgICAgZGVsZXRlIHF1ZXJ5LmNvZGVcbiAgICAgIGRlbGV0ZSBxdWVyeS5zdGF0ZVxuICAgICAgY29uc3QgcmVwbGFjZVVSTCA9IGJ1aWxkVVJMKGdldENsZWFuVVJMKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSwgcXVlcnkpICsgd2luZG93LmxvY2F0aW9uLmhhc2hcbiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCAnJywgcmVwbGFjZVVSTClcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gYXdhaXQgdGhpcy5nZXRBY2Nlc3NUb2tlbih7IGNvZGUgfSlcbiAgICAgIHJldHVybiBhY2Nlc3NUb2tlblxuICAgIH1cbiAgICByZXR1cm4gbnVsbFxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB1c2VyIGFjY2VzcyB0b2tlbiB2aWEgYGNvZGVgXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmNvZGUgLSBUaGUgY29kZSBmcm9tIHRoZSBxdWVyeVxuICAgKlxuICAgKiBAcmV0dXJuIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL29hdXRoMi5odG1sIzItcmVxdWVzdGluZy1hY2Nlc3MtdG9rZW5cbiAgICovXG4gIGFzeW5jIGdldEFjY2Vzc1Rva2VuICh7XG4gICAgY29kZSxcbiAgfToge1xuICAgIGNvZGU6IHN0cmluZ1xuICB9KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAucG9zdChgaHR0cHM6Ly9jb3JzLWFueXdoZXJlLmhlcm9rdWFwcC5jb20vJHtjb25jYXRVUkwodGhpcy5iYXNlVVJMLCAnb2F1dGgvdG9rZW4nKX1gLCB7XG4gICAgICBjbGllbnRfaWQ6IHRoaXMuY2xpZW50SWQsXG4gICAgICBjbGllbnRfc2VjcmV0OiB0aGlzLmNsaWVudFNlY3JldCxcbiAgICAgIGNvZGUsXG4gICAgICBncmFudF90eXBlOiAnYXV0aG9yaXphdGlvbl9jb2RlJyxcbiAgICAgIHJlZGlyZWN0X3VyaTogd2luZG93LmxvY2F0aW9uLmhyZWYsXG4gICAgfSlcbiAgICByZXR1cm4gZGF0YS5hY2Nlc3NfdG9rZW5cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGxvZ2luZWQgdXNlciB3aXRoIGFjY2VzcyB0b2tlbi5cbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKlxuICAgKiBAcmV0dXJuIFRoZSB1c2VyXG4gICAqL1xuICBhc3luYyBnZXRVc2VyICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgfSk6IFByb21pc2U8VnNzdWVBUEkuVXNlcj4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5nZXQoJ2FwaS92NC91c2VyJywge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gbm9ybWFsaXplVXNlcihkYXRhKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBpc3N1ZSBvZiB0aGlzIHBhZ2UgYWNjb3JkaW5nIHRvIHRoZSBpc3N1ZSBpZCBvciB0aGUgaXNzdWUgdGl0bGVcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0gb3B0aW9ucy5pc3N1ZUlkIC0gVGhlIGlkIG9mIGlzc3VlXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlVGl0bGUgLSBUaGUgdGl0bGUgb2YgaXNzdWVcbiAgICpcbiAgICogQHJldHVybiBUaGUgaXNzdWVcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvaXNzdWVzLmh0bWwjc2luZ2xlLWlzc3VlXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL2lzc3Vlcy5odG1sI2xpc3QtaXNzdWVzXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL1JFQURNRS5odG1sI3BhZ2luYXRpb25cbiAgICovXG5cbiAgYXN5bmMgZ2V0SXNzdWUgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICBpc3N1ZUlkLFxuICAgIGlzc3VlVGl0bGUsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgICBpc3N1ZUlkPzogc3RyaW5nIHwgbnVtYmVyXG4gICAgaXNzdWVUaXRsZT86IHN0cmluZ1xuICB9KTogUHJvbWlzZTxWc3N1ZUFQSS5Jc3N1ZSB8IG51bGw+IHtcbiAgICBjb25zdCBvcHRpb25zOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7fVxuXG4gICAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgICBvcHRpb25zLmhlYWRlcnMgPSB7XG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FjY2Vzc1Rva2VufWAsXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGlzc3VlSWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5nZXQoYGFwaS92NC9wcm9qZWN0cy8ke3RoaXMuX2VuY29kZWRSZXBvfS9pc3N1ZXMvJHtpc3N1ZUlkfWAsIG9wdGlvbnMpXG4gICAgICAgIHJldHVybiBub3JtYWxpemVJc3N1ZShkYXRhKVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5yZXNwb25zZSAmJiBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBlXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgb3B0aW9ucy5wYXJhbXMgPSB7XG4gICAgICAgIGxhYmVsczogdGhpcy5sYWJlbHMsXG4gICAgICAgIG9yZGVyX2J5OiAnY3JlYXRlZF9hdCcsXG4gICAgICAgIHNvcnQ6ICdhc2MnLFxuICAgICAgICBzZWFyY2g6IGlzc3VlVGl0bGUsXG4gICAgICB9XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZ2V0KGBhcGkvdjQvcHJvamVjdHMvJHt0aGlzLl9lbmNvZGVkUmVwb30vaXNzdWVzYCwgb3B0aW9ucylcbiAgICAgIGNvbnN0IGlzc3VlID0gZGF0YS5tYXAobm9ybWFsaXplSXNzdWUpLmZpbmQoaXRlbSA9PiBpdGVtLnRpdGxlID09PSBpc3N1ZVRpdGxlKVxuICAgICAgcmV0dXJuIGlzc3VlIHx8IG51bGxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGlzc3VlXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmFjY2Vzc1Rva2VuIC0gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICogQHBhcmFtIG9wdGlvbnMudGl0bGUgLSBUaGUgdGl0bGUgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29udGVudCAtIFRoZSBjb250ZW50IG9mIGlzc3VlXG4gICAqXG4gICAqIEByZXR1cm4gVGhlIGNyZWF0ZWQgaXNzdWVcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvaXNzdWVzLmh0bWwjbmV3LWlzc3VlXG4gICAqL1xuICBhc3luYyBwb3N0SXNzdWUgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICB0aXRsZSxcbiAgICBjb250ZW50LFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gICAgdGl0bGU6IHN0cmluZ1xuICAgIGNvbnRlbnQ6IHN0cmluZ1xuICB9KTogUHJvbWlzZTxWc3N1ZUFQSS5Jc3N1ZT4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5wb3N0KGBhcGkvdjQvcHJvamVjdHMvJHt0aGlzLl9lbmNvZGVkUmVwb30vaXNzdWVzYCwge1xuICAgICAgdGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbjogY29udGVudCxcbiAgICAgIGxhYmVsczogdGhpcy5sYWJlbHMsXG4gICAgfSwge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gbm9ybWFsaXplSXNzdWUoZGF0YSlcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY29tbWVudHMgb2YgdGhpcyBwYWdlIGFjY29yZGluZyB0byB0aGUgaXNzdWUgaWQgb3IgdGhlIGlzc3VlIHRpdGxlXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmFjY2Vzc1Rva2VuIC0gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICogQHBhcmFtIG9wdGlvbnMuaXNzdWVJZCAtIFRoZSBpZCBvZiBpc3N1ZVxuICAgKiBAcGFyYW0gb3B0aW9ucy5xdWVyeSAtIFRoZSBxdWVyeSBwYXJhbWV0ZXJzXG4gICAqXG4gICAqIEByZXR1cm4gVGhlIGNvbW1lbnRzXG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL25vdGVzLmh0bWwjbGlzdC1wcm9qZWN0LWlzc3VlLW5vdGVzXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL1JFQURNRS5odG1sI3BhZ2luYXRpb25cbiAgICpcbiAgICogQHJlbWFya3NcbiAgICogQ2Fubm90IGdldCB0aGUgSFRNTCBjb250ZW50IGFuZCB0aGUgcmVhY3Rpb25zIChhd2FyZF9lbW9qaSkgaGVyZS5cbiAgICogU28gaGF2ZSB0byByZXF1ZXN0IHRoZW0gdmlhIGBtYXJrZG93bmAgYW5kIGBhd2FyZF9lbW9qaWAgQVBJLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29tbWVudHMgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICBpc3N1ZUlkLFxuICAgIHF1ZXJ5OiB7XG4gICAgICBwYWdlID0gMSxcbiAgICAgIHBlclBhZ2UgPSAxMCxcbiAgICAgIHNvcnQgPSAnZGVzYycsXG4gICAgfSA9IHt9LFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gICAgaXNzdWVJZDogc3RyaW5nIHwgbnVtYmVyXG4gICAgcXVlcnk/OiBQYXJ0aWFsPFZzc3VlQVBJLlF1ZXJ5PlxuICB9KTogUHJvbWlzZTxWc3N1ZUFQSS5Db21tZW50cz4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IEF4aW9zUmVxdWVzdENvbmZpZyA9IHtcbiAgICAgIHBhcmFtczoge1xuICAgICAgICAvLyBwYWdpbmF0aW9uXG4gICAgICAgICdwYWdlJzogcGFnZSxcbiAgICAgICAgJ3Blcl9wYWdlJzogcGVyUGFnZSxcbiAgICAgICAgJ29yZGVyX2J5JzogJ2NyZWF0ZWRfYXQnLFxuICAgICAgICAnc29ydCc6IHNvcnQsXG4gICAgICB9LFxuICAgIH1cbiAgICBpZiAoYWNjZXNzVG9rZW4pIHtcbiAgICAgIG9wdGlvbnMuaGVhZGVycyA9IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YWNjZXNzVG9rZW59YCxcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLiRodHRwLmdldChgYXBpL3Y0L3Byb2plY3RzLyR7dGhpcy5fZW5jb2RlZFJlcG99L2lzc3Vlcy8ke2lzc3VlSWR9L25vdGVzYCwgb3B0aW9ucylcbiAgICBjb25zdCBjb21tZW50c1JhdyA9IHJlc3BvbnNlLmRhdGFcblxuICAgIC8vIGdpdGxhYiBhcGkgdjQgc2hvdWxkIGdldCBwYXJzZWQgbWFya2Rvd24gY29udGVudCBhbmQgcmVhY3Rpb25zIGJ5IG90aGVyIGFwaVxuICAgIC8vIHRoaXMgaXMgcG90ZW50aWFsbHkgdG8gY2F1c2UgNDI5IFRvbyBNYW55IFJlcXVlc3RzXG4gICAgY29uc3QgZ2V0Q29tbWVudHNNZXRhOiBBcnJheTxQcm9taXNlPHZvaWQ+PiA9IFtdXG5cbiAgICBmb3IgKGNvbnN0IGNvbW1lbnQgb2YgY29tbWVudHNSYXcpIHtcbiAgICAgIGdldENvbW1lbnRzTWV0YS5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbW1lbnQuYm9keV9odG1sID0gYXdhaXQgdGhpcy5nZXRNYXJrZG93bkNvbnRlbnQoe1xuICAgICAgICAgIGFjY2Vzc1Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgICAgICBjb250ZW50UmF3OiBjb21tZW50LmJvZHksXG4gICAgICAgIH0pXG4gICAgICB9KSgpKVxuICAgICAgZ2V0Q29tbWVudHNNZXRhLnB1c2goKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29tbWVudC5yZWFjdGlvbnMgPSBhd2FpdCB0aGlzLmdldENvbW1lbnRSZWFjdGlvbnMoe1xuICAgICAgICAgIGFjY2Vzc1Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgICAgICBpc3N1ZUlkOiBpc3N1ZUlkLFxuICAgICAgICAgIGNvbW1lbnRJZDogY29tbWVudC5pZCxcbiAgICAgICAgfSlcbiAgICAgIH0pKCkpXG4gICAgfVxuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoZ2V0Q29tbWVudHNNZXRhKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvdW50OiBOdW1iZXIocmVzcG9uc2UuaGVhZGVyc1sneC10b3RhbCddKSxcbiAgICAgIHBhZ2U6IE51bWJlcihyZXNwb25zZS5oZWFkZXJzWyd4LXBhZ2UnXSksXG4gICAgICBwZXJQYWdlOiBOdW1iZXIocmVzcG9uc2UuaGVhZGVyc1sneC1wZXItcGFnZSddKSxcbiAgICAgIGRhdGE6IGNvbW1lbnRzUmF3Lm1hcChub3JtYWxpemVDb21tZW50KSxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGNvbW1lbnRcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0gb3B0aW9ucy5pc3N1ZUlkIC0gVGhlIGlkIG9mIGlzc3VlXG4gICAqIEBwYXJhbSBvcHRpb25zLmNvbnRlbnQgLSBUaGUgY29udGVudCBvZiBjb21tZW50XG4gICAqXG4gICAqIEByZXR1cm4gVGhlIGNyZWF0ZWQgY29tbWVudFxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRsYWIuY29tL2NlL2FwaS9ub3Rlcy5odG1sI2NyZWF0ZS1uZXctaXNzdWUtbm90ZVxuICAgKi9cbiAgYXN5bmMgcG9zdENvbW1lbnQgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICBpc3N1ZUlkLFxuICAgIGNvbnRlbnQsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgICBpc3N1ZUlkOiBzdHJpbmcgfCBudW1iZXJcbiAgICBjb250ZW50OiBzdHJpbmdcbiAgfSk6IFByb21pc2U8VnNzdWVBUEkuQ29tbWVudD4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5wb3N0KGBhcGkvdjQvcHJvamVjdHMvJHt0aGlzLl9lbmNvZGVkUmVwb30vaXNzdWVzLyR7aXNzdWVJZH0vbm90ZXNgLCB7XG4gICAgICBib2R5OiBjb250ZW50LFxuICAgIH0sIHtcbiAgICAgIGhlYWRlcnM6IHsgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YWNjZXNzVG9rZW59YCB9LFxuICAgIH0pXG4gICAgcmV0dXJuIG5vcm1hbGl6ZUNvbW1lbnQoZGF0YSlcbiAgfVxuXG4gIC8qKlxuICAgKiBFZGl0IGEgY29tbWVudFxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlSWQgLSBUaGUgaWQgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29tbWVudElkIC0gVGhlIGlkIG9mIGNvbW1lbnRcbiAgICogQHBhcmFtIG9wdGlvbnMuY29udGVudCAtIFRoZSBjb250ZW50IG9mIGNvbW1lbnRcbiAgICpcbiAgICogQHJldHVybiBUaGUgZWRpdGVkIGNvbW1lbnRcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvbm90ZXMuaHRtbCNtb2RpZnktZXhpc3RpbmctaXNzdWUtbm90ZVxuICAgKi9cbiAgYXN5bmMgcHV0Q29tbWVudCAoe1xuICAgIGFjY2Vzc1Rva2VuLFxuICAgIGlzc3VlSWQsXG4gICAgY29tbWVudElkLFxuICAgIGNvbnRlbnQsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgICBpc3N1ZUlkOiBzdHJpbmcgfCBudW1iZXJcbiAgICBjb21tZW50SWQ6IHN0cmluZyB8IG51bWJlclxuICAgIGNvbnRlbnQ6IHN0cmluZ1xuICB9KTogUHJvbWlzZTxWc3N1ZUFQSS5Db21tZW50PiB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLiRodHRwLnB1dChgYXBpL3Y0L3Byb2plY3RzLyR7dGhpcy5fZW5jb2RlZFJlcG99L2lzc3Vlcy8ke2lzc3VlSWR9L25vdGVzLyR7Y29tbWVudElkfWAsIHtcbiAgICAgIGJvZHk6IGNvbnRlbnQsXG4gICAgfSwge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcblxuICAgIGNvbnN0IFtjb250ZW50SFRNTCwgcmVhY3Rpb25zXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMuZ2V0TWFya2Rvd25Db250ZW50KHtcbiAgICAgICAgYWNjZXNzVG9rZW46IGFjY2Vzc1Rva2VuLFxuICAgICAgICBjb250ZW50UmF3OiBkYXRhLmJvZHksXG4gICAgICB9KSxcbiAgICAgIHRoaXMuZ2V0Q29tbWVudFJlYWN0aW9ucyh7XG4gICAgICAgIGFjY2Vzc1Rva2VuOiBhY2Nlc3NUb2tlbixcbiAgICAgICAgaXNzdWVJZDogaXNzdWVJZCxcbiAgICAgICAgY29tbWVudElkOiBkYXRhLmlkLFxuICAgICAgfSksXG4gICAgXSlcblxuICAgIGRhdGEuYm9keV9odG1sID0gY29udGVudEhUTUxcbiAgICBkYXRhLnJlYWN0aW9ucyA9IHJlYWN0aW9uc1xuXG4gICAgcmV0dXJuIG5vcm1hbGl6ZUNvbW1lbnQoZGF0YSlcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYSBjb21tZW50XG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmFjY2Vzc1Rva2VuIC0gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICogQHBhcmFtIG9wdGlvbnMuaXNzdWVJZCAtIFRoZSBpZCBvZiBpc3N1ZVxuICAgKiBAcGFyYW0gb3B0aW9ucy5jb21tZW50SWQgLSBUaGUgaWQgb2YgY29tbWVudFxuICAgKlxuICAgKiBAcmV0dXJuIGB0cnVlYCBpZiBzdWNjZWVkLCBgZmFsc2VgIGlmIGZhaWxlZFxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRsYWIuY29tL2NlL2FwaS9ub3Rlcy5odG1sI2RlbGV0ZS1hbi1pc3N1ZS1ub3RlXG4gICAqL1xuICBhc3luYyBkZWxldGVDb21tZW50ICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gICAgaXNzdWVJZCxcbiAgICBjb21tZW50SWQsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgICBpc3N1ZUlkOiBzdHJpbmcgfCBudW1iZXJcbiAgICBjb21tZW50SWQ6IHN0cmluZyB8IG51bWJlclxuICB9KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgeyBzdGF0dXMgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZGVsZXRlKGBhcGkvdjQvcHJvamVjdHMvJHt0aGlzLl9lbmNvZGVkUmVwb30vaXNzdWVzLyR7aXNzdWVJZH0vbm90ZXMvJHtjb21tZW50SWR9YCwge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gc3RhdHVzID09PSAyMDRcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmVhY3Rpb25zIG9mIGEgY29tbWVudFxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlSWQgLSBUaGUgaWQgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29tbWVudElkIC0gVGhlIGlkIG9mIGNvbW1lbnRcbiAgICpcbiAgICogQHJldHVybiBUaGUgY29tbWVudHNcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvYXdhcmRfZW1vamkuaHRtbCNsaXN0LWFuLWF3YXJkYWJsZXMtYXdhcmQtZW1vamlcbiAgICovXG4gIGFzeW5jIGdldENvbW1lbnRSZWFjdGlvbnMgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICBpc3N1ZUlkLFxuICAgIGNvbW1lbnRJZCxcbiAgfToge1xuICAgIGFjY2Vzc1Rva2VuOiBWc3N1ZUFQSS5BY2Nlc3NUb2tlblxuICAgIGlzc3VlSWQ6IHN0cmluZyB8IG51bWJlclxuICAgIGNvbW1lbnRJZDogc3RyaW5nIHwgbnVtYmVyXG4gIH0pOiBQcm9taXNlPFZzc3VlQVBJLlJlYWN0aW9ucz4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5nZXQoYGFwaS92NC9wcm9qZWN0cy8ke3RoaXMuX2VuY29kZWRSZXBvfS9pc3N1ZXMvJHtpc3N1ZUlkfS9ub3Rlcy8ke2NvbW1lbnRJZH0vYXdhcmRfZW1vamlgLCB7XG4gICAgICBoZWFkZXJzOiB7ICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FjY2Vzc1Rva2VufWAgfSxcbiAgICB9KVxuICAgIHJldHVybiBub3JtYWxpemVSZWFjdGlvbnMoZGF0YSlcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgcmVhY3Rpb24gb2YgYSBjb21tZW50XG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmFjY2Vzc1Rva2VuIC0gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICogQHBhcmFtIG9wdGlvbnMuaXNzdWVJZCAtIFRoZSBpZCBvZiBpc3N1ZVxuICAgKiBAcGFyYW0gb3B0aW9ucy5jb21tZW50SWQgLSBUaGUgaWQgb2YgY29tbWVudFxuICAgKiBAcGFyYW0gb3B0aW9ucy5yZWFjdGlvbiAtIFRoZSByZWFjdGlvblxuICAgKlxuICAgKiBAcmV0dXJuIGB0cnVlYCBpZiBzdWNjZWVkLCBgZmFsc2VgIGlmIGFscmVhZHkgdG9rZW5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuZ2l0bGFiLmNvbS9jZS9hcGkvYXdhcmRfZW1vamkuaHRtbCNhd2FyZC1hLW5ldy1lbW9qaVxuICAgKi9cbiAgYXN5bmMgcG9zdENvbW1lbnRSZWFjdGlvbiAoe1xuICAgIGlzc3VlSWQsXG4gICAgY29tbWVudElkLFxuICAgIHJlYWN0aW9uLFxuICAgIGFjY2Vzc1Rva2VuLFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gICAgaXNzdWVJZDogc3RyaW5nIHwgbnVtYmVyXG4gICAgY29tbWVudElkOiBzdHJpbmcgfCBudW1iZXJcbiAgICByZWFjdGlvbjoga2V5b2YgVnNzdWVBUEkuUmVhY3Rpb25zXG4gIH0pOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLiRodHRwLnBvc3QoYGFwaS92NC9wcm9qZWN0cy8ke3RoaXMuX2VuY29kZWRSZXBvfS9pc3N1ZXMvJHtpc3N1ZUlkfS9ub3Rlcy8ke2NvbW1lbnRJZH0vYXdhcmRfZW1vamlgLCB7XG4gICAgICAgIG5hbWU6IG1hcFJlYWN0aW9uTmFtZShyZWFjdGlvbiksXG4gICAgICB9LCB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMgPT09IDIwMVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIGl0IGNvdWxkIGJlIGEgYnVnIG9mIGdpdGxhYlxuICAgICAgLy8gaWYgYSByZWFjdGlvbiAoYXdhcmQgZW1vamkpIGhhcyBhbHJlYWR5IGV4aXN0ZWQsIGl0IHJldHVybnMgYSA0MDQgcmVzcG9uc2Ugd2l0aCBhIGJ1Z2d5IG1lc3NhZ2VcbiAgICAgIC8vIGhhdmUgc3VibWl0dGVkIGFuIGlzc3VlOiBodHRwczovL2dpdGxhYi5jb20vZ2l0bGFiLW9yZy9naXRsYWItY2UvaXNzdWVzLzU2MTQ3XG4gICAgICBpZiAoZS5yZXNwb25zZSAmJiBlLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHBhcnNlIEhUTUwgb2YgbWFya2Rvd24gY29udGVudFxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqIEBwYXJhbSBvcHRpb25zLmNvbnRlbnRSYXcgLSBUaGUgaWQgb2YgaXNzdWVcbiAgICpcbiAgICogQHJldHVybiBUaGUgSFRNTCBzdHJpbmcgb2YgcGFyc2VkIG1hcmtkb3duXG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vY2UvYXBpL21hcmtkb3duLmh0bWxcbiAgICovXG4gIGFzeW5jIGdldE1hcmtkb3duQ29udGVudCAoe1xuICAgIGFjY2Vzc1Rva2VuLFxuICAgIGNvbnRlbnRSYXcsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbj86IHN0cmluZyB8IG51bGwsXG4gICAgY29udGVudFJhdzogc3RyaW5nLFxuICB9KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBvcHRpb25zOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7fVxuICAgIGlmIChhY2Nlc3NUb2tlbikge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzID0ge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gLFxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAucG9zdChgYXBpL3Y0L21hcmtkb3duYCwge1xuICAgICAgdGV4dDogY29udGVudFJhdyxcbiAgICAgIGdmbTogdHJ1ZSxcbiAgICB9LCBvcHRpb25zKVxuICAgIHJldHVybiBkYXRhLmh0bWxcbiAgfVxufVxuIl19