import * as tslib_1 from "tslib";
import axios from 'axios';
import { buildQuery, buildURL, concatURL, getCleanURL, parseQuery, } from '@vssue/utils';
import { normalizeUser, normalizeIssue, normalizeComment, } from './utils';
/**
 * Bitbucket API V2
 *
 * @see https://developer.atlassian.com/bitbucket/api/2/reference/
 * @see https://confluence.atlassian.com/bitbucket/oauth-on-bitbucket-cloud-238027431.html
 */
var BitbucketV2 = /** @class */ (function () {
    function BitbucketV2(_a) {
        var _b = _a.baseURL, baseURL = _b === void 0 ? 'https://bitbucket.org' : _b, owner = _a.owner, repo = _a.repo, clientId = _a.clientId, clientSecret = _a.clientSecret, state = _a.state;
        this.baseURL = baseURL;
        this.owner = owner;
        this.repo = repo;
        this.clientId = clientId;
        this.clientSecret = clientSecret;
        this.state = state;
        this.$http = axios.create({
            baseURL: 'https://api.bitbucket.org/2.0',
            headers: {
                'Accept': 'application/json',
            },
        });
    }
    Object.defineProperty(BitbucketV2.prototype, "platform", {
        /**
         * The platform api info
         */
        get: function () {
            return {
                name: 'Bitbucket',
                link: this.baseURL,
                version: 'v2',
                meta: {
                    reactable: false,
                    sortable: true,
                },
            };
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Redirect to the authorization page of platform.
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/meta/authentication#oauth-2
     */
    BitbucketV2.prototype.redirectAuth = function () {
        window.location.href = buildURL(concatURL(this.baseURL, 'site/oauth2/authorize'), {
            client_id: this.clientId,
            redirect_uri: window.location.href,
            response_type: 'code',
        });
    };
    /**
     * Handle authorization.
     *
     * @return A string for access token, `null` for no authorization code
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/meta/authentication#oauth-2
     *
     * @remarks
     * If the `code` exists in the query, remove them from query, and try to get the access token.
     */
    BitbucketV2.prototype.handleAuth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var query, code, replaceURL, accessToken;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        query = parseQuery(window.location.search);
                        if (!query.code) return [3 /*break*/, 2];
                        code = query.code;
                        delete query.code;
                        replaceURL = buildURL(getCleanURL(window.location.href), query) + window.location.hash;
                        window.history.replaceState(null, '', replaceURL);
                        return [4 /*yield*/, this.getAccessToken({ code: code })];
                    case 1:
                        accessToken = _a.sent();
                        return [2 /*return*/, accessToken];
                    case 2: return [2 /*return*/, null];
                }
            });
        });
    };
    /**
     * Get user access token via `code`
     *
     * @param options.code - The code from the query
     *
     * @return User access token
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/meta/authentication#oauth-2
     */
    BitbucketV2.prototype.getAccessToken = function (_a) {
        var code = _a.code;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("https://cors-anywhere.herokuapp.com/" + concatURL(this.baseURL, 'site/oauth2/access_token'), buildQuery({
                            grant_type: 'authorization_code',
                            redirect_uri: window.location.href,
                            code: code,
                        }), {
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            auth: {
                                username: this.clientId,
                                password: this.clientSecret,
                            },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, data.access_token];
                }
            });
        });
    };
    /**
     * Get the logined user with access token.
     *
     * @param options.accessToken - User access token
     *
     * @return The user
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/user
     */
    BitbucketV2.prototype.getUser = function (_a) {
        var accessToken = _a.accessToken;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.get('user', {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeUser(data)];
                }
            });
        });
    };
    /**
     * Get issue of this page according to the issue id or the issue title
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.issueTitle - The title of issue
     *
     * @return The raw response of issue
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues/%7Bissue_id%7D#get
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues#get
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/meta/pagination
     */
    BitbucketV2.prototype.getIssue = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, issueTitle = _a.issueTitle;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, data, e_1, data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        options = {};
                        if (accessToken) {
                            options.headers = {
                                'Authorization': "Bearer " + accessToken,
                            };
                        }
                        if (!issueId) return [3 /*break*/, 5];
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 3, , 4]);
                        options.params = {
                            // to avoid caching
                            timestamp: Date.now(),
                        };
                        return [4 /*yield*/, this.$http.get("repositories/" + this.owner + "/" + this.repo + "/issues/" + issueId, options)];
                    case 2:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeIssue(data)];
                    case 3:
                        e_1 = _b.sent();
                        if (e_1.response && e_1.response.status === 404) {
                            return [2 /*return*/, null];
                        }
                        else {
                            throw e_1;
                        }
                        return [3 /*break*/, 4];
                    case 4: return [3 /*break*/, 7];
                    case 5:
                        options.params = {
                            sort: 'created_on',
                            q: "title=\"" + issueTitle + "\"",
                            // to avoid caching
                            timestamp: Date.now(),
                        };
                        return [4 /*yield*/, this.$http.get("repositories/" + this.owner + "/" + this.repo + "/issues", options)];
                    case 6:
                        data = (_b.sent()).data;
                        return [2 /*return*/, data.size > 0 ? normalizeIssue(data.values[0]) : null];
                    case 7: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Create a new issue
     *
     * @param options.accessToken - User access token
     * @param options.title - The title of issue
     * @param options.content - The content of issue
     *
     * @return The created issue
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues#post
     */
    BitbucketV2.prototype.postIssue = function (_a) {
        var accessToken = _a.accessToken, title = _a.title, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("repositories/" + this.owner + "/" + this.repo + "/issues", {
                            title: title,
                            content: {
                                raw: content,
                            },
                            priority: 'trivial',
                            type: 'task',
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeIssue(data)];
                }
            });
        });
    };
    /**
     * Get comments of this page according to the issue id or the issue title
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.query - The query parameters
     *
     * @return The comments
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues/%7Bissue_id%7D/comments#post
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/meta/pagination
     */
    BitbucketV2.prototype.getComments = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, _b = _a.query, _c = _b === void 0 ? {} : _b, _d = _c.page, page = _d === void 0 ? 1 : _d, _e = _c.perPage, perPage = _e === void 0 ? 10 : _e, _f = _c.sort, sort = _f === void 0 ? 'desc' : _f;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, data;
            return tslib_1.__generator(this, function (_g) {
                switch (_g.label) {
                    case 0:
                        options = {
                            params: {
                                // pagination
                                'page': page,
                                'pagelen': perPage,
                                'sort': sort === 'desc' ? '-created_on' : 'created_on',
                                // to avoid caching
                                timestamp: Date.now(),
                            },
                        };
                        if (accessToken) {
                            options.headers = {
                                'Authorization': "Bearer " + accessToken,
                            };
                        }
                        return [4 /*yield*/, this.$http.get("repositories/" + this.owner + "/" + this.repo + "/issues/" + issueId + "/comments", options)];
                    case 1:
                        data = (_g.sent()).data;
                        return [2 /*return*/, {
                                count: data.size,
                                page: data.page,
                                perPage: data.pagelen,
                                data: data.values.map(normalizeComment),
                            }];
                }
            });
        });
    };
    /**
     * Create a new comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.content - The content of comment
     *
     * @return The created comment
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues/%7Bissue_id%7D/comments#post
     */
    BitbucketV2.prototype.postComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.post("repositories/" + this.owner + "/" + this.repo + "/issues/" + issueId + "/comments", {
                            content: {
                                raw: content,
                            },
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeComment(data)];
                }
            });
        });
    };
    /**
     * Edit a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     * @param options.content - The content of comment
     *
     * @return The edited comment
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues/%7Bissue_id%7D/comments/%7Bcomment_id%7D#put
     */
    BitbucketV2.prototype.putComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, commentId = _a.commentId, content = _a.content;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.put("repositories/" + this.owner + "/" + this.repo + "/issues/" + issueId + "/comments/" + commentId, {
                            content: {
                                raw: content,
                            },
                        }, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        data = (_b.sent()).data;
                        return [2 /*return*/, normalizeComment(data)];
                }
            });
        });
    };
    /**
     * Delete a comment
     *
     * @param options.accessToken - User access token
     * @param options.issueId - The id of issue
     * @param options.commentId - The id of comment
     *
     * @return `true` if succeed, `false` if failed
     *
     * @see https://developer.atlassian.com/bitbucket/api/2/reference/resource/repositories/%7Busername%7D/%7Brepo_slug%7D/issues/%7Bissue_id%7D/comments/%7Bcomment_id%7D#delete
     */
    BitbucketV2.prototype.deleteComment = function (_a) {
        var accessToken = _a.accessToken, issueId = _a.issueId, commentId = _a.commentId;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var status;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.$http.delete("repositories/" + this.owner + "/" + this.repo + "/issues/" + issueId + "/comments/" + commentId, {
                            headers: { 'Authorization': "Bearer " + accessToken },
                        })];
                    case 1:
                        status = (_b.sent()).status;
                        return [2 /*return*/, status === 204];
                }
            });
        });
    };
    /**
     * Bitbucket does not support reactions now
     */
    BitbucketV2.prototype.getCommentReactions = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                throw new Error('501 Not Implemented');
            });
        });
    };
    /**
     * Bitbucket does not support reactions now
     */
    BitbucketV2.prototype.postCommentReaction = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                throw new Error('501 Not Implemented');
            });
        });
    };
    return BitbucketV2;
}());
export default BitbucketV2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLE9BQU8sS0FHTixNQUFNLE9BQU8sQ0FBQTtBQUVkLE9BQU8sRUFDTCxVQUFVLEVBQ1YsUUFBUSxFQUNSLFNBQVMsRUFDVCxXQUFXLEVBQ1gsVUFBVSxHQUNYLE1BQU0sY0FBYyxDQUFBO0FBRXJCLE9BQU8sRUFDTCxhQUFhLEVBQ2IsY0FBYyxFQUNkLGdCQUFnQixHQUNqQixNQUFNLFNBQVMsQ0FBQTtBQUVoQjs7Ozs7R0FLRztBQUNIO0lBU0UscUJBQWEsRUFPTTtZQU5qQixlQUFpQyxFQUFqQyxzREFBaUMsRUFDakMsZ0JBQUssRUFDTCxjQUFJLEVBQ0osc0JBQVEsRUFDUiw4QkFBWSxFQUNaLGdCQUFLO1FBRUwsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7UUFDdEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbEIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUE7UUFFaEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUE7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUE7UUFDaEMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFFbEIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3hCLE9BQU8sRUFBRSwrQkFBK0I7WUFDeEMsT0FBTyxFQUFFO2dCQUNQLFFBQVEsRUFBRSxrQkFBa0I7YUFDN0I7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0lBS0Qsc0JBQUksaUNBQVE7UUFIWjs7V0FFRzthQUNIO1lBQ0UsT0FBTztnQkFDTCxJQUFJLEVBQUUsV0FBVztnQkFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNsQixPQUFPLEVBQUUsSUFBSTtnQkFDYixJQUFJLEVBQUU7b0JBQ0osU0FBUyxFQUFFLEtBQUs7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QUFhLFNBQVcsRUFBRTs0QkFDdkgsT0FBTyxFQUFFO2dDQUNQLEdBQUcsRUFBRSxPQUFPOzZCQUNiO3lCQUNGLEVBQUU7NEJBQ0QsT0FBTyxFQUFFLEVBQUUsZUFBZSxFQUFFLFlBQVUsV0FBYSxFQUFFO3lCQUN0RCxDQUFDLEVBQUE7O3dCQU5NLElBQUksR0FBSyxDQUFBLFNBTWYsQ0FBQSxLQU5VO3dCQU9aLHNCQUFPLGdCQUFnQixDQUFDLElBQUksQ0FBQyxFQUFBOzs7O0tBQzlCO0lBRUQ7Ozs7Ozs7Ozs7T0FVRztJQUNHLG1DQUFhLEdBQW5CLFVBQXFCLEVBUXBCO1lBUEMsNEJBQVcsRUFDWCxvQkFBTyxFQUNQLHdCQUFTOzs7Ozs0QkFNVSxxQkFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxrQkFBZ0IsSUFBSSxDQUFDLEtBQUssU0FBSSxJQUFJLENBQUMsSUFBSSxnQkFBVyxPQUFPLGtCQUFhLFNBQVcsRUFBRTs0QkFDNUgsT0FBTyxFQUFFLEVBQUUsZUFBZSxFQUFFLFlBQVUsV0FBYSxFQUFFO3lCQUN0RCxDQUFDLEVBQUE7O3dCQUZNLE1BQU0sR0FBSyxDQUFBLFNBRWpCLENBQUEsT0FGWTt3QkFHZCxzQkFBTyxNQUFNLEtBQUssR0FBRyxFQUFBOzs7O0tBQ3RCO0lBRUQ7O09BRUc7SUFDRyx5Q0FBbUIsR0FBekI7OztnQkFDRSxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUE7OztLQUN2QztJQUVEOztPQUVHO0lBQ0cseUNBQW1CLEdBQXpCOzs7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBOzs7S0FDdkM7SUFDSCxrQkFBQztBQUFELENBQUMsQUF2WEQsSUF1WEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWc3N1ZUFQSSB9IGZyb20gJ3Zzc3VlJ1xuXG5pbXBvcnQgYXhpb3MsIHtcbiAgQXhpb3NJbnN0YW5jZSxcbiAgQXhpb3NSZXF1ZXN0Q29uZmlnLFxufSBmcm9tICdheGlvcydcblxuaW1wb3J0IHtcbiAgYnVpbGRRdWVyeSxcbiAgYnVpbGRVUkwsXG4gIGNvbmNhdFVSTCxcbiAgZ2V0Q2xlYW5VUkwsXG4gIHBhcnNlUXVlcnksXG59IGZyb20gJ0B2c3N1ZS91dGlscydcblxuaW1wb3J0IHtcbiAgbm9ybWFsaXplVXNlcixcbiAgbm9ybWFsaXplSXNzdWUsXG4gIG5vcm1hbGl6ZUNvbW1lbnQsXG59IGZyb20gJy4vdXRpbHMnXG5cbi8qKlxuICogQml0YnVja2V0IEFQSSBWMlxuICpcbiAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIuYXRsYXNzaWFuLmNvbS9iaXRidWNrZXQvYXBpLzIvcmVmZXJlbmNlL1xuICogQHNlZSBodHRwczovL2NvbmZsdWVuY2UuYXRsYXNzaWFuLmNvbS9iaXRidWNrZXQvb2F1dGgtb24tYml0YnVja2V0LWNsb3VkLTIzODAyNzQzMS5odG1sXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJpdGJ1Y2tldFYyIGltcGxlbWVudHMgVnNzdWVBUEkuSW5zdGFuY2Uge1xuICBiYXNlVVJMOiBzdHJpbmdcbiAgb3duZXI6IHN0cmluZ1xuICByZXBvOiBzdHJpbmdcbiAgY2xpZW50SWQ6IHN0cmluZ1xuICBjbGllbnRTZWNyZXQ6IHN0cmluZ1xuICBzdGF0ZTogc3RyaW5nXG4gICRodHRwOiBBeGlvc0luc3RhbmNlXG5cbiAgY29uc3RydWN0b3IgKHtcbiAgICBiYXNlVVJMID0gJ2h0dHBzOi8vYml0YnVja2V0Lm9yZycsXG4gICAgb3duZXIsXG4gICAgcmVwbyxcbiAgICBjbGllbnRJZCxcbiAgICBjbGllbnRTZWNyZXQsXG4gICAgc3RhdGUsXG4gIH06IFZzc3VlQVBJLk9wdGlvbnMpIHtcbiAgICB0aGlzLmJhc2VVUkwgPSBiYXNlVVJMXG4gICAgdGhpcy5vd25lciA9IG93bmVyXG4gICAgdGhpcy5yZXBvID0gcmVwb1xuXG4gICAgdGhpcy5jbGllbnRJZCA9IGNsaWVudElkXG4gICAgdGhpcy5jbGllbnRTZWNyZXQgPSBjbGllbnRTZWNyZXRcbiAgICB0aGlzLnN0YXRlID0gc3RhdGVcblxuICAgIHRoaXMuJGh0dHAgPSBheGlvcy5jcmVhdGUoe1xuICAgICAgYmFzZVVSTDogJ2h0dHBzOi8vYXBpLmJpdGJ1Y2tldC5vcmcvMi4wJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgIH0sXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgcGxhdGZvcm0gYXBpIGluZm9cbiAgICovXG4gIGdldCBwbGF0Zm9ybSAoKTogVnNzdWVBUEkuUGxhdGZvcm0ge1xuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiAnQml0YnVja2V0JyxcbiAgICAgIGxpbms6IHRoaXMuYmFzZVVSTCxcbiAgICAgIHZlcnNpb246ICd2MicsXG4gICAgICBtZXRhOiB7XG4gICAgICAgIHJlYWN0YWJsZTogZmFsc2UsXG4gICAgICAgIHNvcnRhYmxlOiB0cnVlLFxuICAgICAgfSxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVkaXJlY3QgdG8gdGhlIGF1dGhvcml6YXRpb24gcGFnZSBvZiBwbGF0Zm9ybS5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvbWV0YS9hdXRoZW50aWNhdGlvbiNvYXV0aC0yXG4gICAqL1xuICByZWRpcmVjdEF1dGggKCk6IHZvaWQge1xuICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gYnVpbGRVUkwoY29uY2F0VVJMKHRoaXMuYmFzZVVSTCwgJ3NpdGUvb2F1dGgyL2F1dGhvcml6ZScpLCB7XG4gICAgICBjbGllbnRfaWQ6IHRoaXMuY2xpZW50SWQsXG4gICAgICByZWRpcmVjdF91cmk6IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuICAgICAgcmVzcG9uc2VfdHlwZTogJ2NvZGUnLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIGF1dGhvcml6YXRpb24uXG4gICAqXG4gICAqIEByZXR1cm4gQSBzdHJpbmcgZm9yIGFjY2VzcyB0b2tlbiwgYG51bGxgIGZvciBubyBhdXRob3JpemF0aW9uIGNvZGVcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvbWV0YS9hdXRoZW50aWNhdGlvbiNvYXV0aC0yXG4gICAqXG4gICAqIEByZW1hcmtzXG4gICAqIElmIHRoZSBgY29kZWAgZXhpc3RzIGluIHRoZSBxdWVyeSwgcmVtb3ZlIHRoZW0gZnJvbSBxdWVyeSwgYW5kIHRyeSB0byBnZXQgdGhlIGFjY2VzcyB0b2tlbi5cbiAgICovXG4gIGFzeW5jIGhhbmRsZUF1dGggKCk6IFByb21pc2U8VnNzdWVBUEkuQWNjZXNzVG9rZW4+IHtcbiAgICBjb25zdCBxdWVyeSA9IHBhcnNlUXVlcnkod2luZG93LmxvY2F0aW9uLnNlYXJjaClcbiAgICBpZiAocXVlcnkuY29kZSkge1xuICAgICAgY29uc3QgY29kZSA9IHF1ZXJ5LmNvZGVcbiAgICAgIGRlbGV0ZSBxdWVyeS5jb2RlXG4gICAgICBjb25zdCByZXBsYWNlVVJMID0gYnVpbGRVUkwoZ2V0Q2xlYW5VUkwod2luZG93LmxvY2F0aW9uLmhyZWYpLCBxdWVyeSkgKyB3aW5kb3cubG9jYXRpb24uaGFzaFxuICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCByZXBsYWNlVVJMKVxuICAgICAgY29uc3QgYWNjZXNzVG9rZW4gPSBhd2FpdCB0aGlzLmdldEFjY2Vzc1Rva2VuKHsgY29kZSB9KVxuICAgICAgcmV0dXJuIGFjY2Vzc1Rva2VuXG4gICAgfVxuICAgIHJldHVybiBudWxsXG4gIH1cblxuICAvKipcbiAgICogR2V0IHVzZXIgYWNjZXNzIHRva2VuIHZpYSBgY29kZWBcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuY29kZSAtIFRoZSBjb2RlIGZyb20gdGhlIHF1ZXJ5XG4gICAqXG4gICAqIEByZXR1cm4gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvbWV0YS9hdXRoZW50aWNhdGlvbiNvYXV0aC0yXG4gICAqL1xuICBhc3luYyBnZXRBY2Nlc3NUb2tlbiAoe1xuICAgIGNvZGUsXG4gIH06IHtcbiAgICBjb2RlOiBzdHJpbmdcbiAgfSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLiRodHRwLnBvc3QoYGh0dHBzOi8vY29ycy1hbnl3aGVyZS5oZXJva3VhcHAuY29tLyR7Y29uY2F0VVJMKHRoaXMuYmFzZVVSTCwgJ3NpdGUvb2F1dGgyL2FjY2Vzc190b2tlbicpfWAsIGJ1aWxkUXVlcnkoe1xuICAgICAgZ3JhbnRfdHlwZTogJ2F1dGhvcml6YXRpb25fY29kZScsXG4gICAgICByZWRpcmVjdF91cmk6IHdpbmRvdy5sb2NhdGlvbi5ocmVmLFxuICAgICAgY29kZSxcbiAgICB9KSwge1xuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXG4gICAgICB9LFxuICAgICAgYXV0aDoge1xuICAgICAgICB1c2VybmFtZTogdGhpcy5jbGllbnRJZCxcbiAgICAgICAgcGFzc3dvcmQ6IHRoaXMuY2xpZW50U2VjcmV0LFxuICAgICAgfSxcbiAgICB9KVxuICAgIHJldHVybiBkYXRhLmFjY2Vzc190b2tlblxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgbG9naW5lZCB1c2VyIHdpdGggYWNjZXNzIHRva2VuLlxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqXG4gICAqIEByZXR1cm4gVGhlIHVzZXJcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvcmVzb3VyY2UvdXNlclxuICAgKi9cbiAgYXN5bmMgZ2V0VXNlciAoe1xuICAgIGFjY2Vzc1Rva2VuLFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gIH0pOiBQcm9taXNlPFZzc3VlQVBJLlVzZXI+IHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZ2V0KCd1c2VyJywge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gbm9ybWFsaXplVXNlcihkYXRhKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBpc3N1ZSBvZiB0aGlzIHBhZ2UgYWNjb3JkaW5nIHRvIHRoZSBpc3N1ZSBpZCBvciB0aGUgaXNzdWUgdGl0bGVcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0gb3B0aW9ucy5pc3N1ZUlkIC0gVGhlIGlkIG9mIGlzc3VlXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlVGl0bGUgLSBUaGUgdGl0bGUgb2YgaXNzdWVcbiAgICpcbiAgICogQHJldHVybiBUaGUgcmF3IHJlc3BvbnNlIG9mIGlzc3VlXG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIuYXRsYXNzaWFuLmNvbS9iaXRidWNrZXQvYXBpLzIvcmVmZXJlbmNlL3Jlc291cmNlL3JlcG9zaXRvcmllcy8lN0J1c2VybmFtZSU3RC8lN0JyZXBvX3NsdWclN0QvaXNzdWVzLyU3Qmlzc3VlX2lkJTdEI2dldFxuICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLmF0bGFzc2lhbi5jb20vYml0YnVja2V0L2FwaS8yL3JlZmVyZW5jZS9yZXNvdXJjZS9yZXBvc2l0b3JpZXMvJTdCdXNlcm5hbWUlN0QvJTdCcmVwb19zbHVnJTdEL2lzc3VlcyNnZXRcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvbWV0YS9wYWdpbmF0aW9uXG4gICAqL1xuICBhc3luYyBnZXRJc3N1ZSAoe1xuICAgIGFjY2Vzc1Rva2VuLFxuICAgIGlzc3VlSWQsXG4gICAgaXNzdWVUaXRsZSxcbiAgfToge1xuICAgIGFjY2Vzc1Rva2VuOiBWc3N1ZUFQSS5BY2Nlc3NUb2tlblxuICAgIGlzc3VlSWQ/OiBzdHJpbmcgfCBudW1iZXJcbiAgICBpc3N1ZVRpdGxlPzogc3RyaW5nXG4gIH0pOiBQcm9taXNlPFZzc3VlQVBJLklzc3VlIHwgbnVsbD4ge1xuICAgIGNvbnN0IG9wdGlvbnM6IEF4aW9zUmVxdWVzdENvbmZpZyA9IHt9XG5cbiAgICBpZiAoYWNjZXNzVG9rZW4pIHtcbiAgICAgIG9wdGlvbnMuaGVhZGVycyA9IHtcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YWNjZXNzVG9rZW59YCxcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaXNzdWVJZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgb3B0aW9ucy5wYXJhbXMgPSB7XG4gICAgICAgICAgLy8gdG8gYXZvaWQgY2FjaGluZ1xuICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZ2V0KGByZXBvc2l0b3JpZXMvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyR7aXNzdWVJZH1gLCBvcHRpb25zKVxuICAgICAgICByZXR1cm4gbm9ybWFsaXplSXNzdWUoZGF0YSlcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUucmVzcG9uc2UgJiYgZS5yZXNwb25zZS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAgIHJldHVybiBudWxsXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbnMucGFyYW1zID0ge1xuICAgICAgICBzb3J0OiAnY3JlYXRlZF9vbicsXG4gICAgICAgIHE6IGB0aXRsZT1cIiR7aXNzdWVUaXRsZX1cImAsXG4gICAgICAgIC8vIHRvIGF2b2lkIGNhY2hpbmdcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfVxuICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLiRodHRwLmdldChgcmVwb3NpdG9yaWVzLyR7dGhpcy5vd25lcn0vJHt0aGlzLnJlcG99L2lzc3Vlc2AsIG9wdGlvbnMpXG4gICAgICByZXR1cm4gZGF0YS5zaXplID4gMCA/IG5vcm1hbGl6ZUlzc3VlKGRhdGEudmFsdWVzWzBdKSA6IG51bGxcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGlzc3VlXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zLmFjY2Vzc1Rva2VuIC0gVXNlciBhY2Nlc3MgdG9rZW5cbiAgICogQHBhcmFtIG9wdGlvbnMudGl0bGUgLSBUaGUgdGl0bGUgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29udGVudCAtIFRoZSBjb250ZW50IG9mIGlzc3VlXG4gICAqXG4gICAqIEByZXR1cm4gVGhlIGNyZWF0ZWQgaXNzdWVcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvcmVzb3VyY2UvcmVwb3NpdG9yaWVzLyU3QnVzZXJuYW1lJTdELyU3QnJlcG9fc2x1ZyU3RC9pc3N1ZXMjcG9zdFxuICAgKi9cbiAgYXN5bmMgcG9zdElzc3VlICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gICAgdGl0bGUsXG4gICAgY29udGVudCxcbiAgfToge1xuICAgIGFjY2Vzc1Rva2VuOiBWc3N1ZUFQSS5BY2Nlc3NUb2tlblxuICAgIHRpdGxlOiBzdHJpbmdcbiAgICBjb250ZW50OiBzdHJpbmdcbiAgfSk6IFByb21pc2U8VnNzdWVBUEkuSXNzdWU+IHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAucG9zdChgcmVwb3NpdG9yaWVzLyR7dGhpcy5vd25lcn0vJHt0aGlzLnJlcG99L2lzc3Vlc2AsIHtcbiAgICAgIHRpdGxlLFxuICAgICAgY29udGVudDoge1xuICAgICAgICByYXc6IGNvbnRlbnQsXG4gICAgICB9LFxuICAgICAgcHJpb3JpdHk6ICd0cml2aWFsJyxcbiAgICAgIHR5cGU6ICd0YXNrJyxcbiAgICB9LCB7XG4gICAgICBoZWFkZXJzOiB7ICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FjY2Vzc1Rva2VufWAgfSxcbiAgICB9KVxuICAgIHJldHVybiBub3JtYWxpemVJc3N1ZShkYXRhKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb21tZW50cyBvZiB0aGlzIHBhZ2UgYWNjb3JkaW5nIHRvIHRoZSBpc3N1ZSBpZCBvciB0aGUgaXNzdWUgdGl0bGVcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0gb3B0aW9ucy5pc3N1ZUlkIC0gVGhlIGlkIG9mIGlzc3VlXG4gICAqIEBwYXJhbSBvcHRpb25zLnF1ZXJ5IC0gVGhlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICpcbiAgICogQHJldHVybiBUaGUgY29tbWVudHNcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvcmVzb3VyY2UvcmVwb3NpdG9yaWVzLyU3QnVzZXJuYW1lJTdELyU3QnJlcG9fc2x1ZyU3RC9pc3N1ZXMvJTdCaXNzdWVfaWQlN0QvY29tbWVudHMjcG9zdFxuICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLmF0bGFzc2lhbi5jb20vYml0YnVja2V0L2FwaS8yL3JlZmVyZW5jZS9tZXRhL3BhZ2luYXRpb25cbiAgICovXG4gIGFzeW5jIGdldENvbW1lbnRzICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gICAgaXNzdWVJZCxcbiAgICBxdWVyeToge1xuICAgICAgcGFnZSA9IDEsXG4gICAgICBwZXJQYWdlID0gMTAsXG4gICAgICBzb3J0ID0gJ2Rlc2MnLFxuICAgIH0gPSB7fSxcbiAgfToge1xuICAgIGFjY2Vzc1Rva2VuOiBWc3N1ZUFQSS5BY2Nlc3NUb2tlblxuICAgIGlzc3VlSWQ6IHN0cmluZyB8IG51bWJlclxuICAgIHF1ZXJ5PzogUGFydGlhbDxWc3N1ZUFQSS5RdWVyeT5cbiAgfSk6IFByb21pc2U8VnNzdWVBUEkuQ29tbWVudHM+IHtcbiAgICBjb25zdCBvcHRpb25zOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7XG4gICAgICBwYXJhbXM6IHtcbiAgICAgICAgLy8gcGFnaW5hdGlvblxuICAgICAgICAncGFnZSc6IHBhZ2UsXG4gICAgICAgICdwYWdlbGVuJzogcGVyUGFnZSxcbiAgICAgICAgJ3NvcnQnOiBzb3J0ID09PSAnZGVzYycgPyAnLWNyZWF0ZWRfb24nIDogJ2NyZWF0ZWRfb24nLFxuICAgICAgICAvLyB0byBhdm9pZCBjYWNoaW5nXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH0sXG4gICAgfVxuICAgIGlmIChhY2Nlc3NUb2tlbikge1xuICAgICAgb3B0aW9ucy5oZWFkZXJzID0ge1xuICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gLFxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZ2V0KGByZXBvc2l0b3JpZXMvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyR7aXNzdWVJZH0vY29tbWVudHNgLCBvcHRpb25zKVxuICAgIHJldHVybiB7XG4gICAgICBjb3VudDogZGF0YS5zaXplLFxuICAgICAgcGFnZTogZGF0YS5wYWdlLFxuICAgICAgcGVyUGFnZTogZGF0YS5wYWdlbGVuLFxuICAgICAgZGF0YTogZGF0YS52YWx1ZXMubWFwKG5vcm1hbGl6ZUNvbW1lbnQpLFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgY29tbWVudFxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlSWQgLSBUaGUgaWQgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29udGVudCAtIFRoZSBjb250ZW50IG9mIGNvbW1lbnRcbiAgICpcbiAgICogQHJldHVybiBUaGUgY3JlYXRlZCBjb21tZW50XG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIuYXRsYXNzaWFuLmNvbS9iaXRidWNrZXQvYXBpLzIvcmVmZXJlbmNlL3Jlc291cmNlL3JlcG9zaXRvcmllcy8lN0J1c2VybmFtZSU3RC8lN0JyZXBvX3NsdWclN0QvaXNzdWVzLyU3Qmlzc3VlX2lkJTdEL2NvbW1lbnRzI3Bvc3RcbiAgICovXG4gIGFzeW5jIHBvc3RDb21tZW50ICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gICAgaXNzdWVJZCxcbiAgICBjb250ZW50LFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gICAgaXNzdWVJZDogc3RyaW5nIHwgbnVtYmVyXG4gICAgY29udGVudDogc3RyaW5nXG4gIH0pOiBQcm9taXNlPFZzc3VlQVBJLkNvbW1lbnQ+IHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuJGh0dHAucG9zdChgcmVwb3NpdG9yaWVzLyR7dGhpcy5vd25lcn0vJHt0aGlzLnJlcG99L2lzc3Vlcy8ke2lzc3VlSWR9L2NvbW1lbnRzYCwge1xuICAgICAgY29udGVudDoge1xuICAgICAgICByYXc6IGNvbnRlbnQsXG4gICAgICB9LFxuICAgIH0sIHtcbiAgICAgIGhlYWRlcnM6IHsgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YWNjZXNzVG9rZW59YCB9LFxuICAgIH0pXG4gICAgcmV0dXJuIG5vcm1hbGl6ZUNvbW1lbnQoZGF0YSlcbiAgfVxuXG4gIC8qKlxuICAgKiBFZGl0IGEgY29tbWVudFxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9ucy5hY2Nlc3NUb2tlbiAtIFVzZXIgYWNjZXNzIHRva2VuXG4gICAqIEBwYXJhbSBvcHRpb25zLmlzc3VlSWQgLSBUaGUgaWQgb2YgaXNzdWVcbiAgICogQHBhcmFtIG9wdGlvbnMuY29tbWVudElkIC0gVGhlIGlkIG9mIGNvbW1lbnRcbiAgICogQHBhcmFtIG9wdGlvbnMuY29udGVudCAtIFRoZSBjb250ZW50IG9mIGNvbW1lbnRcbiAgICpcbiAgICogQHJldHVybiBUaGUgZWRpdGVkIGNvbW1lbnRcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5hdGxhc3NpYW4uY29tL2JpdGJ1Y2tldC9hcGkvMi9yZWZlcmVuY2UvcmVzb3VyY2UvcmVwb3NpdG9yaWVzLyU3QnVzZXJuYW1lJTdELyU3QnJlcG9fc2x1ZyU3RC9pc3N1ZXMvJTdCaXNzdWVfaWQlN0QvY29tbWVudHMvJTdCY29tbWVudF9pZCU3RCNwdXRcbiAgICovXG4gIGFzeW5jIHB1dENvbW1lbnQgKHtcbiAgICBhY2Nlc3NUb2tlbixcbiAgICBpc3N1ZUlkLFxuICAgIGNvbW1lbnRJZCxcbiAgICBjb250ZW50LFxuICB9OiB7XG4gICAgYWNjZXNzVG9rZW46IFZzc3VlQVBJLkFjY2Vzc1Rva2VuXG4gICAgaXNzdWVJZDogc3RyaW5nIHwgbnVtYmVyXG4gICAgY29tbWVudElkOiBzdHJpbmcgfCBudW1iZXJcbiAgICBjb250ZW50OiBzdHJpbmdcbiAgfSk6IFByb21pc2U8VnNzdWVBUEkuQ29tbWVudD4ge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy4kaHR0cC5wdXQoYHJlcG9zaXRvcmllcy8ke3RoaXMub3duZXJ9LyR7dGhpcy5yZXBvfS9pc3N1ZXMvJHtpc3N1ZUlkfS9jb21tZW50cy8ke2NvbW1lbnRJZH1gLCB7XG4gICAgICBjb250ZW50OiB7XG4gICAgICAgIHJhdzogY29udGVudCxcbiAgICAgIH0sXG4gICAgfSwge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gbm9ybWFsaXplQ29tbWVudChkYXRhKVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIGNvbW1lbnRcbiAgICpcbiAgICogQHBhcmFtIG9wdGlvbnMuYWNjZXNzVG9rZW4gLSBVc2VyIGFjY2VzcyB0b2tlblxuICAgKiBAcGFyYW0gb3B0aW9ucy5pc3N1ZUlkIC0gVGhlIGlkIG9mIGlzc3VlXG4gICAqIEBwYXJhbSBvcHRpb25zLmNvbW1lbnRJZCAtIFRoZSBpZCBvZiBjb21tZW50XG4gICAqXG4gICAqIEByZXR1cm4gYHRydWVgIGlmIHN1Y2NlZWQsIGBmYWxzZWAgaWYgZmFpbGVkXG4gICAqXG4gICAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIuYXRsYXNzaWFuLmNvbS9iaXRidWNrZXQvYXBpLzIvcmVmZXJlbmNlL3Jlc291cmNlL3JlcG9zaXRvcmllcy8lN0J1c2VybmFtZSU3RC8lN0JyZXBvX3NsdWclN0QvaXNzdWVzLyU3Qmlzc3VlX2lkJTdEL2NvbW1lbnRzLyU3QmNvbW1lbnRfaWQlN0QjZGVsZXRlXG4gICAqL1xuICBhc3luYyBkZWxldGVDb21tZW50ICh7XG4gICAgYWNjZXNzVG9rZW4sXG4gICAgaXNzdWVJZCxcbiAgICBjb21tZW50SWQsXG4gIH06IHtcbiAgICBhY2Nlc3NUb2tlbjogVnNzdWVBUEkuQWNjZXNzVG9rZW5cbiAgICBpc3N1ZUlkOiBzdHJpbmcgfCBudW1iZXJcbiAgICBjb21tZW50SWQ6IHN0cmluZyB8IG51bWJlclxuICB9KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgeyBzdGF0dXMgfSA9IGF3YWl0IHRoaXMuJGh0dHAuZGVsZXRlKGByZXBvc2l0b3JpZXMvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyR7aXNzdWVJZH0vY29tbWVudHMvJHtjb21tZW50SWR9YCwge1xuICAgICAgaGVhZGVyczogeyAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gIH0sXG4gICAgfSlcbiAgICByZXR1cm4gc3RhdHVzID09PSAyMDRcbiAgfVxuXG4gIC8qKlxuICAgKiBCaXRidWNrZXQgZG9lcyBub3Qgc3VwcG9ydCByZWFjdGlvbnMgbm93XG4gICAqL1xuICBhc3luYyBnZXRDb21tZW50UmVhY3Rpb25zICgpOiBQcm9taXNlPFZzc3VlQVBJLlJlYWN0aW9ucz4ge1xuICAgIHRocm93IG5ldyBFcnJvcignNTAxIE5vdCBJbXBsZW1lbnRlZCcpXG4gIH1cblxuICAvKipcbiAgICogQml0YnVja2V0IGRvZXMgbm90IHN1cHBvcnQgcmVhY3Rpb25zIG5vd1xuICAgKi9cbiAgYXN5bmMgcG9zdENvbW1lbnRSZWFjdGlvbiAoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCc1MDEgTm90IEltcGxlbWVudGVkJylcbiAgfVxufVxuIl19